#!/usr/bin/env python3

import os , sys , json , subprocess , operator , time

CACHE = os.path.expanduser( '~/.cache/memoize' )
VALUE = ':.?..?+:@#&|^<\\$µù£'
TIME = 'ç&èà%£*¨/\\°)-²³£´`~'
RETURNCODE = 'è§§"!§é!è§é!§é!è'
NOW = time.time( )

validity = float(sys.argv[1])
command = sys.argv[2:]

def lookup ( cache , command ) :

    for i , part in enumerate( command ) :

        if part in cache : cache = cache[part]

        else : return ( False , cache , command[i:] )

    return ( True , cache , [ ] )

try :

    with open( CACHE , 'r' ) as _cache :

        cache = json.load( _cache )

except FileNotFoundError :

    cache = {}

found , entry , rest = lookup( cache , command )

if not found or not VALUE in entry or entry[TIME] + validity < NOW :

    if not found :

        for part in rest :

            entry[part] = { }
            entry = entry[part]
    p = subprocess.run( command , stdout = subprocess.PIPE )
    entry[VALUE] = p.stdout.decode( 'utf8' )
    entry[TIME] = NOW
    entry[RETURNCODE] = p.returncode

    with open( CACHE , 'w' ) as _cache :

        json.dump( cache , _cache )

print( entry[VALUE] , end = '' )
sys.exit( entry[RETURNCODE] )
